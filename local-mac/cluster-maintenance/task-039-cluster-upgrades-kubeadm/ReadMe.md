### Cluster Upgrade - Kubeadm example
[kubeadm-upgrade](https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/)

[kubernetes/playground](https://www.katacoda.com/courses/kubernetes/playground)

- To ensure that cluster was set up using kubeadm command
```bash
controlplane $ kubeadm token list
TOKEN                     TTL         EXPIRES                USAGES                   DESCRIPTION                EXTRA GROUPS
96771a.f608976060d16396   23h         2021-01-21T18:43:08Z   authentication,signing   The default bootstrap token generated by 'kubeadm init'.   system:bootstrappers:kubeadm:default-node-token
```

- Current version of kubernetes
```bash
controlplane $ kubectl get nodes
NAME           STATUS   ROLES    AGE   VERSION
controlplane   Ready    master   35m   v1.18.0
node01         Ready    <none>   35m   v1.18.0
```

- Check the OS version
```bash
controlplane $ cat /etc/*release*
DISTRIB_ID=Ubuntu
DISTRIB_RELEASE=18.04
DISTRIB_CODENAME=bionic
DISTRIB_DESCRIPTION="Ubuntu 18.04.5 LTS"
NAME="Ubuntu"
VERSION="18.04.5 LTS (Bionic Beaver)"
ID=ubuntu
ID_LIKE=debian
PRETTY_NAME="Ubuntu 18.04.5 LTS"
VERSION_ID="18.04"
HOME_URL="https://www.ubuntu.com/"
SUPPORT_URL="https://help.ubuntu.com/"
BUG_REPORT_URL="https://bugs.launchpad.net/ubuntu/"
PRIVACY_POLICY_URL="https://www.ubuntu.com/legal/terms-and-policies/privacy-policy"
VERSION_CODENAME=bionic
UBUNTU_CODENAME=bionic
```

- update
```bash
controlplane $ apt update

controlplane $ apt-cache madison kubeadm
```

- Upgrading the control-plane nodes
```bash
apt-mark unhold kubeadm && \
apt-get update && apt-get install -y kubeadm=1.19.6-00 && \
apt-mark hold kubeadm
```

- Check the kubeadm version now
```bash
controlplane $ kubeadm version
kubeadm version: &version.Info{Major:"1", Minor:"19", GitVersion:"v1.19.6", GitCommit:"fbf646b339dc52336b55d8ec85c181981b86331a", GitTreeState:"clean", BuildDate:"2020-12-18T12:07:25Z", GoVersion:"go1.15.5", Compiler:"gc", Platform:"linux/amd64"}
```

- On the control plane node, run:
```bash
controlplane $ sudo kubeadm upgrade plan
```

- Apply the upgrade
```bash
controlplane $ sudo kubeadm upgrade apply v1.19.6
.
[upgrade/successful] SUCCESS! Your cluster was upgraded to "v1.19.6". Enjoy!
```

- Upgrade additional control plane nodes
```bash
$ sudo kubeadm upgrade node
```

- Drain the control plane node. Prepare the node for maintenance by marking it unschedulable and evicting the workloads:
```bash
controlplane $ kubectl drain controlplane --ignore-daemonsetsnode/controlplane cordoned
WARNING: ignoring DaemonSet-managed Pods: kube-system/kube-flannel-ds-amd64-4qxgq, kube-system/kube-proxy-hvpmp
evicting pod kube-system/coredns-f9fd979d6-6lrsx
pod/coredns-f9fd979d6-6lrsx evicted
node/controlplane evicted
```

- Upgrade kubelet and kubectl
```bash
$ apt-mark unhold kubelet kubectl && \
apt-get update && apt-get install -y kubelet=1.19.6-00 kubectl=1.19.6-00 && \
apt-mark hold kubelet kubectl

$ apt-get update && \
apt-get install -y --allow-change-held-packages kubelet=1.19.6-00 kubectl=1.19.6-00
```

- Restart the kubelet
```bash
controlplane $ sudo systemctl daemon-reload
controlplane $ sudo systemctl restart kubelet
```

- Uncordon the control plane node
```bash
controlplane $ kubectl uncordon controlplane
node/controlplane uncordoned
```

- Check the version now
```bash
controlplane $ kubectl get nodes
NAME           STATUS   ROLES    AGE   VERSION
controlplane   Ready    master   24m   v1.19.6
node01         Ready    <none>   23m   v1.18.0
```

### Upgrade worker nodes

- Upgrade kubeadm
```bash
node01 $ apt-mark unhold kubeadm && \
> apt-get update && apt-get install -y kubeadm=1.19.6-00 && \
> apt-mark hold kubeadm

node01 $ apt-get update && \
> apt-get install -y --allow-change-held-packages kubeadm=1.19.6-00

```

- Upgrade the kubelet configuration
```bash
node01 $ sudo kubeadm upgrade node
```

- Drain the node. Note we are running this on controlplane node.
```bash
controlplane $ kubectl drain node01 --ignore-daemonsets
node/node01 cordoned
WARNING: ignoring DaemonSet-managed Pods: kube-system/kube-flannel-ds-amd64-clgqs, kube-system/kube-keepalived-vip-pgdzt, kube-system/kube-proxy-qsxw2
evicting pod kube-system/katacoda-cloud-provider-58f89f7d9-9wlxv
evicting pod kube-system/coredns-f9fd979d6-4fn69
evicting pod kube-system/coredns-f9fd979d6-8d9m4
pod/katacoda-cloud-provider-58f89f7d9-9wlxv evicted
pod/coredns-f9fd979d6-8d9m4 evicted
pod/coredns-f9fd979d6-4fn69 evicted
node/node01 evicted
```

- Upgrade kubelet and kubectl
```bash
node01 $ apt-mark unhold kubelet kubectl && \
> apt-get update && apt-get install -y kubelet=1.19.6-00 kubectl=1.19.6-00 && \
> apt-mark hold kubelet kubectl

node01 $ apt-get update && \
> apt-get install -y --allow-change-held-packages kubelet=1.19.6-00 kubectl=1.19.6-00
```

- Restart the kubelet
```bash
node01 $ sudo systemctl daemon-reload
node01 $ sudo systemctl restart kubelet
```

- Uncordon the node
```bash
controlplane $ kubectl uncordon node01
node/node01 uncordoned
```

- Verify the status of the cluster
```bash
controlplane $ kubectl get nodes
NAME           STATUS   ROLES    AGE   VERSION
controlplane   Ready    master   30m   v1.19.6
node01         Ready    <none>   30m   v1.19.6
```
